=== ULTRA-DETAILED LLM PROMPT FOR PHASE 1 COMPLETION ===

CONTEXT:
========
I have a telegram-files fork with Phase 1 architectural refactoring partially complete.

Repository: /Users/fabian/projects/telegram-files
Branch: refactor/phase1-clean
Status: 40% complete, deployed and running

WHAT'S DONE:
- ‚úÖ Package reorganization (22 files in 6 packages)
- ‚úÖ ErrorHandling utility created
- ‚úÖ DownloadStatistics domain object created
- ‚úÖ Application compiles (0 errors)
- ‚úÖ Application deployed and healthy

WHAT'S LEFT:
- ‚è≥ Task 2: Extract FileDownloadService (6-8 hours)
- ‚è≥ Task 3: Initialize ServiceContext (30 minutes)
- ‚è≥ Task 4: Complete DI migration (4-6 hours)

YOUR TASK:
==========
Complete Tasks 2, 3, and 4 following the IMPLEMENTATION_HANDBOOK.md exactly.

CRITICAL RULES (NON-NEGOTIABLE):
================================

RULE 1: COMPILE AFTER EVERY SINGLE CHANGE
After modifying ANY file, run:
```bash
docker build -t test-<step> .
```
If it fails: STOP, FIX, RETEST
NEVER proceed with compilation errors

RULE 2: ONE CHANGE AT A TIME
- Copy ONE method ‚Üí compile ‚Üí commit
- Not: Copy 5 methods ‚Üí compile ‚Üí errors

RULE 3: FOLLOW THE HANDBOOK EXACTLY
- Read IMPLEMENTATION_HANDBOOK.md
- Follow EVERY step in EXACT order
- Run EVERY command shown
- Check EVERY verification
- Do NOT skip steps

RULE 4: NO REFACTORING WHILE COPYING
- Copy code EXACTLY as written
- Only change: DataVerticle ‚Üí context
- Do NOT remove Future.await()
- Do NOT "improve" the logic

RULE 5: TEST FUNCTIONALITY
- After Task 2: Test downloads work
- After Task 3: Test no NullPointerException
- After Task 4: Test all 14 features

DOCUMENTS TO READ:
==================

PRIMARY (READ FIRST):
- refactoring/IMPLEMENTATION_HANDBOOK.md
  ‚Üí Step-by-step instructions with exact commands

SECONDARY (REFERENCE):
- refactoring/COMPLETE_TESTING_GUIDE.md
  ‚Üí How to test each step

- refactoring/TROUBLESHOOTING_GUIDE.md
  ‚Üí Solutions for common problems

- refactoring/LESSONS_LEARNED.md
  ‚Üí What went wrong in first attempt (DON'T repeat)

TASK SEQUENCE:
==============

TASK 2: Extract FileDownloadService
------------------------------------
Step 2.1: Create skeleton ‚Üí compile ‚Üí commit
Step 2.2: Copy startDownload() ‚Üí compile ‚Üí commit
Step 2.3: Copy cancelDownload() ‚Üí compile ‚Üí commit
Step 2.4: Copy togglePauseDownload() ‚Üí compile ‚Üí commit
Step 2.5: Copy downloadThumbnail() ‚Üí compile ‚Üí commit
Step 2.6: Copy syncFileDownloadStatus() ‚Üí compile ‚Üí commit
Step 2.7: Copy helper methods ‚Üí compile ‚Üí commit
Step 2.8: Add delegation ‚Üí compile ‚Üí commit
Step 2.9: Remove old code ‚Üí compile ‚Üí commit
Step 2.10: Test downloads work ‚Üí verify ‚Üí commit

TASK 3: Initialize ServiceContext
----------------------------------
Step 3.1: Add initialization in DataVerticle ‚Üí compile ‚Üí commit
Step 3.2: Deploy and test no NPE ‚Üí verify ‚Üí commit

TASK 4: Complete DI Migration
------------------------------
Step 4.1: Convert DownloadQueueService ‚Üí compile ‚Üí commit
Step 4.2: Update AutoDownloadVerticle ‚Üí compile ‚Üí commit
Step 4.3: Convert HistoryDiscoveryService ‚Üí compile ‚Üí commit
Step 4.4: Update callers ‚Üí compile ‚Üí commit
Step 4.5: Test all 14 features ‚Üí verify ‚Üí commit

REPORTING REQUIREMENTS:
=======================

After EACH step, report:

"Step X.Y: <description>
 Status: ‚úÖ COMPLETE
 Compilation: ‚úÖ PASSED
 Commit: <hash>
 Ready for: Step X.(Y+1)"

OR:

"Step X.Y: <description>
 Status: ‚ùå FAILED
 Error: <exact error message>
 Attempted fix: <what I tried>
 Need help: YES"

QUALITY GATES (MANDATORY):
===========================

After EVERY step:

Gate 1: Compilation
```bash
docker build -t test .
```
MUST show: "DONE", "unpacking"
MUST NOT show: "error:", "BUILD FAILED"

If FAILS: STOP, don't proceed

Gate 2: No uncommitted changes accumulating
```bash
git status
```
SHOULD show: "nothing to commit" (after you commit)

If many uncommitted files: Commit them

Gate 3: Feature still works (after Task 2, 3, 4)
Manual test the relevant feature

If broken: STOP, debug, fix

VERIFICATION COMMANDS:
======================

After Task 2 (Service Extraction):
```bash
# Check service exists
test -f api/src/main/java/telegram/files/download/FileDownloadService.java && echo "‚úÖ" || echo "‚ùå"

# Check size
wc -l api/src/main/java/telegram/files/download/FileDownloadService.java
# EXPECTED: 300-400 lines

# Check TelegramVerticle reduced
wc -l api/src/main/java/telegram/files/core/TelegramVerticle.java
# EXPECTED: 900-1000 lines (was 1,252)

# Check delegation
grep "return downloadService\." api/src/main/java/telegram/files/core/TelegramVerticle.java | wc -l
# EXPECTED: 4+
```

After Task 3 (ServiceContext):
```bash
# Check initialization
grep "serviceContext = new ServiceContext" api/src/main/java/telegram/files/DataVerticle.java
# EXPECTED: Found

# Check no NPE
docker logs telegram-files | grep "NullPointerException"
# EXPECTED: No matches
```

After Task 4 (DI Migration):
```bash
# Check no static access
grep -r "DataVerticle\." api/src/main/java/telegram/files/download/*.java | wc -l
# EXPECTED: 0

# Check context usage
grep -r "context\..*Repository()" api/src/main/java/telegram/files/download/*.java | wc -l
# EXPECTED: 30+
```

COMMON MISTAKES TO AVOID:
==========================

From first refactoring attempt:

MISTAKE 1: Changing multiple files before compiling
PREVENTION: Change 1, compile, commit, repeat

MISTAKE 2: Skipping quality gates to save time
PREVENTION: Gates are NOT optional - follow them

MISTAKE 3: Modifying code while copying it
PREVENTION: Copy EXACTLY, only update references

MISTAKE 4: No incremental testing
PREVENTION: Test after each task completes

MISTAKE 5: Removing Future.await() while copying
PREVENTION: Keep code EXACTLY as-is, don't refactor

MISTAKE 6: Accumulating errors
PREVENTION: Fix errors immediately when they appear

MISTAKE 7: No rollback plan
PREVENTION: Commit after each successful step

WARNING SIGNS:
==============

STOP immediately if you find yourself:

‚ùå "I'll compile after finishing this section"
   ‚Üí NO: Compile NOW

‚ùå "I'll fix the imports later"
   ‚Üí NO: Fix NOW

‚ùå "This small change won't break anything"
   ‚Üí NO: Test it

‚ùå "I'll test everything at the end"
   ‚Üí NO: Test incrementally

‚ùå "I can skip this quality gate"
   ‚Üí NO: Gates are mandatory

If you catch yourself making excuses, you're about to fail.

WHEN TO ASK FOR HELP:
=====================

Ask immediately if:

1. Compilation fails and you can't fix it in 15 minutes
2. Feature doesn't work and you don't know why
3. NullPointerException and can't find cause
4. Spent > 2 hours on one step
5. Unsure about next step
6. Any doubt about what to do

Do NOT struggle for hours - ask for help quickly.

SUCCESS CRITERIA:
=================

Phase 1 remaining work is complete when:

1. ‚úÖ FileDownloadService exists (~300 LOC)
2. ‚úÖ TelegramVerticle < 1,000 LOC
3. ‚úÖ ServiceContext initialized
4. ‚úÖ All download services use DI (0 static calls)
5. ‚úÖ Compilation: 0 errors
6. ‚úÖ Application: Healthy
7. ‚úÖ All 14 features: Working
8. ‚úÖ Tests: All passing

START HERE:
===========

1. cd /Users/fabian/projects/telegram-files
2. git checkout refactor/phase1-clean
3. git pull origin refactor/phase1-clean
4. Verify clean state: git status
5. Open refactoring/IMPLEMENTATION_HANDBOOK.md
6. Read Task 2, Step 2.1
7. Execute Step 2.1 EXACTLY as written
8. Report result
9. Wait for confirmation before Step 2.2

DO NOT RUSH. QUALITY > SPEED.

The first attempt rushed and failed (28 errors, 6 hours wasted).
This attempt will be careful and succeed.

Good luck. Follow the handbook. You will succeed. üéØ

=== END OF ULTRA-DETAILED PROMPT ===


USAGE FOR FUTURE YOU:
=====================
1. When ready to complete Phase 1 remaining work
2. Copy everything between === markers above
3. Paste into new AI conversation
4. AI will follow the IMPLEMENTATION_HANDBOOK step-by-step
5. Review each commit before AI proceeds
6. Estimated: 15 hours of AI work, 3 hours of your review

The handbook is so detailed that mistakes are nearly impossible.

